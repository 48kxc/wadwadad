<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Study Buddy â€” WebLLM (fixed)</title>
  <style>
    body{font-family:Inter,system-ui,Arial; background:#f3f7ff; margin:0; padding:24px; display:flex;justify-content:center}
    .card{width:100%;max-width:820px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.06)}
    h1{margin:0 0 8px 0}
    textarea{width:100%;min-height:120px;border-radius:8px;border:1px solid #d0d7ff;padding:10px;font-size:15px}
    .controls{display:flex;gap:8px;margin-top:12px;align-items:center}
    button{padding:12px 14px;border-radius:10px;border:0;background:#4a66ff;color:#fff;font-weight:600;cursor:pointer}
    #status{font-size:13px;color:#444}
    #output{white-space:pre-wrap;margin-top:14px;line-height:1.45}
    .small{font-size:13px;color:#6b7280}
  </style>
</head>
<body>
  <div class="card">
    <h1>AI Study Buddy ðŸ“š</h1>
    <div class="small">Runs models directly in your browser with WebLLM (no API keys). First load may take time.</div>

    <label style="display:block;margin-top:12px">Enter topic</label>
    <textarea id="topic" placeholder="e.g. Mitosis, The French Revolution, Photosynthesis..."></textarea>

    <div class="controls">
      <button id="generateBtn" disabled>Generate (model not loaded)</button>
      <select id="modelSelect" title="Choose model (availability depends on WebLLM config)" style="padding:8px;border-radius:8px">
        <!-- Default choice. You can change to a prebuilt model name available in your WebLLM config -->
        <option value="Phi-3-mini-4k-instruct-q4f16_1-MLC">Phi-3-mini-4k-instruct (small)</option>
        <option value="Llama-3.1-8B-Instruct">Llama-3.1-8B-Instruct (larger)</option>
      </select>

      <div id="status">Status: waiting to load library...</div>
    </div>

    <div id="output"></div>
  </div>

<script type="module">
(async () => {
  const statusEl = document.getElementById('status');
  const out = document.getElementById('output');
  const btn = document.getElementById('generateBtn');
  const topicEl = document.getElementById('topic');
  const modelSelect = document.getElementById('modelSelect');

  let webllm;        // module namespace
  let engine;        // MLCEngine instance

  // 1) Dynamically import the package (avoids named export mismatch)
  try {
    statusEl.textContent = 'Status: loading web-llm library...';
    // use esm.run (fast) â€” you may swap to jsdelivr/npm CDN if you prefer
    webllm = await import('https://esm.run/@mlc-ai/web-llm');
    statusEl.textContent = 'Status: library loaded.';
  } catch (err) {
    console.error('Failed to import web-llm:', err);
    statusEl.textContent = 'Error: failed to load web-llm library. See console.';
    out.textContent = 'Check devtools console for import error.';
    return;
  }

  // 2) Create MLCEngine using CreateMLCEngine factory (documented API).
  // See docs: CreateMLCEngine / MLCEngine and engine.chat.completions.create(). :contentReference[oaicite:2]{index=2}
  async function loadModel(modelName) {
    try {
      statusEl.textContent = `Status: initializing engine + loading model "${modelName}" (may take some time)...`;
      // Use CreateMLCEngine factory if available
      if (typeof webllm.CreateMLCEngine === 'function') {
        engine = await webllm.CreateMLCEngine(modelName, {
          // optional progress callback (gives fraction 0..1)
          initProgressCallback: (p) => {
            statusEl.textContent = `Status: loading model "${modelName}" â€” ${(p*100).toFixed(0)}%`;
          }
        });
      } else if (typeof webllm.MLCEngine === 'function') {
        // fallback: instantiate and reload
        engine = new webllm.MLCEngine({
          initProgressCallback: (p) => {
            statusEl.textContent = `Status: loading model "${modelName}" â€” ${(p*100).toFixed(0)}%`;
          }
        });
        await engine.reload(modelName);
      } else {
        throw new Error('No CreateMLCEngine or MLCEngine constructor found on imported module.');
      }

      statusEl.textContent = `Status: model "${modelName}" loaded. Ready!`;
      btn.disabled = false;
      btn.textContent = 'Generate Study Materials';
    } catch (err) {
      console.error('Model load error:', err);
      statusEl.textContent = 'Error loading model â€” see console.';
      out.textContent = 'Model failed to load. Try a different model or check network/console.';
    }
  }

  // Load default model initially (user can change selection and reload below)
  await loadModel(modelSelect.value);

  // Allow user to change model and reload it
  modelSelect.addEventListener('change', async () => {
    btn.disabled = true;
    btn.textContent = 'Loading model...';
    out.textContent = '';
    await loadModel(modelSelect.value);
  });

  // 3) Generation handler
  btn.addEventListener('click', async () => {
    const topic = topicEl.value.trim();
    if (!topic) { alert('Enter a topic first.'); return; }

    out.textContent = '';
    statusEl.textContent = 'Status: generating...';
    btn.disabled = true;

    const prompt = `You are an AI study helper. For the topic "${topic}", produce:
1) Short summary (5-7 sentences)
2) 5 flashcards (Q -> A)
3) 5 multiple-choice practice questions
4) One short, funny meme sentence about the topic
Return clear sections with headings.`;

    try {
      // Use the documented chat completions API:
      // engine.chat.completions.create({ messages: [...] })
      // (the engine is preloaded with the chosen model). :contentReference[oaicite:3]{index=3}
      const messages = [
        { role: 'system', content: 'You are a helpful study assistant.' },
        { role: 'user', content: prompt }
      ];

      const reply = await engine.chat.completions.create({
        messages,
        max_tokens: 700,
        temperature: 0.6
      });

      // reply.choices[0].message.content is the textual result
      const text = reply?.choices?.[0]?.message?.content ?? String(reply);
      out.textContent = text;
      statusEl.textContent = 'Status: ready';
    } catch (err) {
      console.error('Generation error:', err);
      out.textContent = 'Generation failed â€” see console for details.';
      statusEl.textContent = 'Error during generation';
    } finally {
      btn.disabled = false;
    }
  });

})();
</script>
</body>
</html>
